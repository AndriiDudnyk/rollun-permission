# Authentication Module

## Содержание

* Введение
* Аутентификация
    * quick-auth
        * Пройдена
        * Не пройдена
    * lazy-auth
        * Пройдена
        * Не пройдена
    * Протоколы аутентификациии
        * BaseAuth
            * Пустой
            * с данными
        * oAuth2
            * без кода 
            * c кодом 
            * с токеном
        * openID
            * без кода 
            * c кодом 
            * с токеном
        * login-pass
            * Пустой
            * с данными
    * Адаптары
        * OpenId
            * Возвращаемые ответы
        * BaseAuth
            * Возвращаемые ответы
        * Null
            * Возвращаемые ответы
    * AuthType Resolver
    * Error Handler
        * AccessForbidden
            * статус "authorised"
            * статус "not authorised"
                * non-ajax запрос
* Идентификация

## Введение

Authentication - модуль который позволяет идентифицироавть, а так же авторизоать пользователя.

Сам модуль Authentication можно разбить на несколько частей
* Authentication - аутентификация пользователя.
* Identification - идентифицирует пользователя.

Итак давйте разберем все по порядку.

## Authentication 

Сама аутентификация делиться на два подмодуля

* quick-Auth - быстрая аутентификация пользователя. 
* lazy-auth - Медленная аутентификация. 

### quick-Auth

Быстрая аутентификация, происходит "на лету". 
Тоесть, если во время запроса, имееться возможность или требуеться авторизировать пользователя до идентификации, 
или например до попадения в ACL, то данный модуль попытаеться это сделать.
 
Для работы данного middleware, мы должны указать, какие адатпары для можно использовать для быстрой авторизации.
    
    конфиг

Давайте теперь рассмотрим pipeLine quick-Auth
 
* quickAuthPipe
    * AllowAdapterResolver - получаем доступный/выбраный адаптер
    * AuthAdapterSwitch  - получаем QuickAuthenticationAction с выбраным адаптером.
        * QuickAuthenticationAction - производим быструю аутентификацию

И так после того как пользователь попал в quick-Auth, его попытаюсться авторезировать. 
Данное событие может завершиться двумя способами

#### Аутентификация пройдена

В этом случае, id пользователя будет передан в аттребуте запроса под именем `identity`. 
А статус авторизации будет записан в сессию. После этого запрос продалжить свой путь по цепочке.

#### Аутентификация не пройдена

В случае если аутентификацию постигла неудача, запрос просто продолжит идти по цепочке. 

### lazy-auth

Длинаая аутентификация, являеться основным действием и целью запроса.
Может реагировать как на запросы пользователя, так и на ajax запросы. Данная метод предусматривать возможность многоэтапнлого процеса аутентификации,
когда сам процес еще не завершен, и для продолжения нужно вернуть ответ пользователю с последующими инструкциями.

Примером таких запросов, являеться аутентификация по OpenID/OAuth, когда пользователя редиректит на сраницу провайдера токена, 
а он в свою очередь запрашивате разрешение у пользователя на предоставление прав к доступа акаунта сторонеему приложению. 
Далее его перенапрявляют на страницу аутентификации уже с секретным кодом, c помощью которого и получают токен сведетельствующий успешной авторизайции.

Так же примером может служить когда для подтверждения аутентификации требуеться ввести пароль из смс. 

Для lazy-auth существует специальный адаптер который в случае пустого запроса, подготовит ответ с html страничкой предоставляющей выбор для метода аутентификации.
> Если таковы приудствуют в настройках.

После того как запрос дошел до авторизации и метод был определен, запрос может завершиться двумя способами.

#### Аутентификация пройдена
    
В случае если аутентификация прошла успешно, статус аутентификации будет записан в сессию. 
А пользователю будет возвращен ответ сведетельствующий об успешном завершении аутентификациии.  
    
#### Аутентификация не пройдена

Если аутентификация не была завершена то ответ подготавливает адаптер. 
Так как он зависит от того была ли аутентификация полностью провалена, или требуеться вернуть управление пользователю для получение дополнительных данных.
 
Давайте теперь рассмотрим pipeLine lazy-auth
 
* AuthActionRender 
    * loginPipe 
        * AllowAdapterResolver - получаем доступный/выбраный адаптер
        * AuthAdapterSwitch - получаем LazyAuthenticationAction с выбраным адаптером.
            * LazyAuthenticationAction - производим аутентификацию 
    * RenderMiddleware - рендерим ответ(если этого нужно) 
    * ReturnerMiddleware - возвращаем ответ
* ErrorHandler - обработка ошибок

## Протокол аутентификациии

Существует множество протокол аутентификации, в данном случае мы рассмотрим самые общее и часто используемые
Рассмотрим варианты работы данных протоколов и их поведение.

### BaseAuth

Данный протокол аутентификации предусматривает передачу логина и пароля в заголовке запроса.
Так же возможен двух-этапный процесс авторизации, когда логина и пароля нет.

Варианты запроса 
#### Пустой
В этом случае сервер должен вернуть ответ сождержащий определенные заголовки указывающее на то что ожидаеться авторизациия по BaseAuth.

#### С данными для аутентификации
Используя переданные данные сервер пытаеться авторизировать пользователя.
 
### openID
 
